# HTTP → HTTPS и www → non-www
<VirtualHost *:80>
    ServerName tandooria.com
    ServerAlias www.tandooria.com
    DocumentRoot /var/www/dispatcher-hub/public

    RewriteEngine On
    # www → non-www
    RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
    RewriteRule ^ http://%1%{REQUEST_URI} [L,R=301]

    # HTTP → HTTPS
    RewriteRule ^ https://tandooria.com%{REQUEST_URI} [L,R=301]
</VirtualHost>

# HTTPS конфигурация сайта
<VirtualHost *:443>
    ServerName tandooria.com
    ServerAlias www.tandooria.com
    DocumentRoot /var/www/dispatcher-hub/public

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/tandooria.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/tandooria.com/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/tandooria.com/chain.pem

    <Directory /var/www/dispatcher-hub/public>
        AllowOverride All
        Require all granted
    </Directory>

    # www → non-www (на HTTPS)
    RewriteEngine On
    RewriteCond %{HTTP_HOST} ^www\. [NC]
    RewriteRule ^ https://tandooria.com%{REQUEST_URI} [L,R=301]

    # SSL-настройки
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLProtocol All -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLHonorCipherOrder On

    # Безопасные заголовки
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</VirtualHost>
